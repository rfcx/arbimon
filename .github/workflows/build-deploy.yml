name: "Build-Deploy"
on:
  push:
    branches:
      - master
      - staging
      - develop
jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: "Setup: Git check out"
        uses: actions/checkout@fd47087372161c6f2a7b96d2ef87e944d89023ed

      - name: "Setup: Extract branch name"
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: "Setup: Set env"
        uses: kanga333/variable-mapper@92703696e9a3f370901c3d53ae3836569b1055e5
        with:
          key: "${{ steps.extract_branch.outputs.branch }}"
          map: |
            {
              "master": {
                "NAMESPACE": "production",
                "ECR_REPO": "biodiversity-analytics",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_PROD_WEBHOOK }}",
                "SLACK_CHANNEL": "alerts-deployment-prod"
              },
              "staging": {
                "NAMESPACE": "staging",
                "ECR_REPO": "biodiversity-analytics/staging",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_WEBHOOK }}",
                "SLACK_CHANNEL": "alerts-deployment"
              },
              ".*": {
                "NAMESPACE": "testing",
                "ECR_REPO": "biodiversity-analytics/testing",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_WEBHOOK }}",
                "SLACK_CHANNEL": "alerts-deployment"
              }
            }

      - name: "Slack: Failure notify"
        uses: ravsamhq/notify-slack-action@c09876e2b9d663560dfe5ea229a8ae677b382afa
        if: always()
        with:
          notification_title: ""
          status: ${{ job.status }}
          notify_when: "failure,warning"
          message_format: "*Biodiversity Analytics (Website):* Build {status_message} on <{commit_url}|{commit_sha}> branch {branch}"
          footer: "<{repo_url}|{repo}> | <{run_url}|View {status_message} Run>"
        env:
          SLACK_WEBHOOK_URL: "${{ env.SLACK_WEBHOOK }}"

      - name: "AWS: Configure credentials"
        uses: aws-actions/configure-aws-credentials@0d9a5be0dceea74e09396820e1e522ba4a110d2f
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "eu-west-1"

      - name: "AWS: Login"
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@aaf69d68aa3fb14c1d5a6be9ac61fe15b48453a2

      - name: "AWS: Build, tag, and push image"
        env:
          ECR_REGISTRY: "887044485231.dkr.ecr.eu-west-1.amazonaws.com"
          ECR_REPOSITORY: "${{ env.ECR_REPO }}"
          IMAGE_TAG: "latest"
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f build/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: "Slack: Build success notify"
        uses: ravsamhq/notify-slack-action@c09876e2b9d663560dfe5ea229a8ae677b382afa
        with:
          notification_title: ""
          status: ${{ job.status }}
          notify_when: "success"
          message_format: "*Biodiversity Analytics (Website):* Build {status_message} on <{commit_url}|{commit_sha}> branch {branch}"
          footer: "Linked actions: <{run_url}|View Run>"
        env:
          SLACK_WEBHOOK_URL: "${{ env.SLACK_WEBHOOK }}"

      - name: "Kubernetes: Deploy"
        uses: actions-hub/kubectl@4eb1c88a390c884024631213c5d7aa65d2b1892f
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG_SUPER }}
        with:
          args: apply -f ./build/${{ env.NAMESPACE }}

      - name: "Slack: Deploy success notify"
        uses: ravsamhq/notify-slack-action@c09876e2b9d663560dfe5ea229a8ae677b382afa
        with:
          notification_title: ""
          status: ${{ job.status }}
          notify_when: "success"
          message_format: "*Biodiversity Analytics (Website):* Deploy {status_message} on <{commit_url}|{commit_sha}> branch {branch}"
          footer: "Linked actions: <{run_url}|View Run>"
        env:
          SLACK_WEBHOOK_URL: "${{ env.SLACK_WEBHOOK }}"