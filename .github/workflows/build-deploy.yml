name: 'Build-Deploy'
on:
  workflow_dispatch:
  push:
    branches:
      - master
      - staging
      - develop
jobs:
  build-deploy:
    runs-on: ubuntu-20.04
    env:
      ECR_REGISTRY: '887044485231.dkr.ecr.eu-west-1.amazonaws.com'
    steps:
      - name: 'Setup: Git check out'
        uses: actions/checkout@ec3a7ce113134d7a93b817d10a8272cb61118579
        # v2 (2.4.0) @ 03 Nov 2021 https://github.com/actions/checkout/tags

      - name: "Setup: Docker Buildx"
        uses: docker/setup-buildx-action@v1

      - name: 'Setup: Extract branch name'
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: 'Setup: Set env'
        uses: kanga333/variable-mapper@92703696e9a3f370901c3d53ae3836569b1055e5
        # v0 (0.2.2) @ 03 Nov 2021 https://github.com/kanga333/variable-mapper/tags
        with:
          key: '${{ steps.extract_branch.outputs.branch }}'
          map: |
            {
              "master": {
                "NAMESPACE": "production",
                "ECR_REPO_WEBSITE": "biodiversity-website",
                "ECR_REPO_API": "biodiversity-api",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_PROD_WEBHOOK }}"
              },
              "staging": {
                "NAMESPACE": "staging",
                "ECR_REPO_WEBSITE": "biodiversity-website/staging",
                "ECR_REPO_API": "biodiversity-api/staging",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_WEBHOOK }}"
              },
              ".*": {
                "NAMESPACE": "testing",
                "ECR_REPO_WEBSITE": "biodiversity-website/testing",
                "ECR_REPO_API": "biodiversity-api/testing",
                "SLACK_WEBHOOK": "${{ secrets.SLACK_ALERT_WEBHOOK }}"
              }
            }

      - name: 'Setup: Configure AWS credentials'
        uses: aws-actions/configure-aws-credentials@0d9a5be0dceea74e09396820e1e522ba4a110d2f
        # v1 (1.5.11) @ 03 Nov 2021 https://github.com/aws-actions/configure-aws-credentials/tags
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'eu-west-1'

      - name: 'Setup: Login to ECR'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@aaf69d68aa3fb14c1d5a6be9ac61fe15b48453a2
        # v1 (1.3.3) @ 03 Nov 2021 https://github.com/aws-actions/amazon-ecr-login/tags

      - name: 'Build: Docker build WEB'
        uses: docker/build-push-action@v2
        with:
          target: website
          file: build/Dockerfile
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            $ECR_REGISTRY/${{ env.ECR_REPO_WEBSITE }}:latest
            $ECR_REGISTRY/${{ env.ECR_REPO_WEBSITE }}:${{ github.run_number }}
            $ECR_REGISTRY/${{ env.ECR_REPO_WEBSITE }}:${GITHUB_SHA::6}   

      - name: 'Build: Docker build API'
        uses: docker/build-push-action@v2
        with:
          target: api
          file: build/Dockerfile
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            $ECR_REGISTRY/${{ env.ECR_REPO_API }}:latest
            $ECR_REGISTRY/${{ env.ECR_REPO_API }}:${{ github.run_number }}
            $ECR_REGISTRY/${{ env.ECR_REPO_API }}:${GITHUB_SHA::6}   

      - name: 'Build: Push images to ECR'
        run: |
          docker push -a $ECR_REGISTRY/${{ env.ECR_REPO_WEBSITE }}
          docker push -a $ECR_REGISTRY/${{ env.ECR_REPO_API }}

      - name: 'Deploy: Set image version'
        run: |
          find build -name "deployment.yaml" -exec sed -i s/:latest/:${{ github.run_number }}/g {} +

      - name: 'Deploy: Kubernetes apply WEB'
        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG_SUPER }}
        with:
          args: apply -f ./build/website/${{ env.NAMESPACE }}

      - name: 'Deploy: Kubernetes apply API'
        uses: actions-hub/kubectl@365773786ebd92c7b36b6ab80e17d4a213ab0cd1
        # v1 (1.21.2) @ 03 Nov 2021 https://github.com/actions-hub/kubectl/tags
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG_SUPER }}
        with:
          args: apply -f ./build/api/${{ env.NAMESPACE }}

      - name: 'Notify: Get author'
        uses: kanga333/variable-mapper@92703696e9a3f370901c3d53ae3836569b1055e5
        # v0 (0.2.2) @ 03 Nov 2021 https://github.com/kanga333/variable-mapper/tags
        with:
          key: '${{ github.event.pusher.name }}'
          map: |
            {
              "charles-allen": {
                "SLACK_MENTION_USERS": "U6LT2N3SS"
              },
              "Nutto55": {
                "SLACK_MENTION_USERS": "UC2NVRCAY"
              },
              "naluinui": {
                "SLACK_MENTION_USERS": "U19GA1FT2"
              },
              "antonyharfield": {
                "SLACK_MENTION_USERS": "U09HZUDUY"
              },
              ".*": {
                "SLACK_MENTION_USERS": "U6LT2N3SS,U19GA1FT2,UC2NVRCAY"
              }
            }

      - name: 'Notify: Slack'
        uses: ravsamhq/notify-slack-action@c09876e2b9d663560dfe5ea229a8ae677b382afa
        # v1 (1.4.0) @ 03 Nov 2021 https://github.com/ravsamhq/notify-slack-action/tags
        if: always()
        with:
          status: ${{ job.status }}
          notify_when: 'success,failure,warning'
          notification_title: '{workflow} {status_message} -- triggered by ${{ github.event.pusher.name }}'
          message_format: '{emoji} *Biodiversity Analytics:* {status_message} deploying ${{ steps.extract_branch.outputs.branch }} to ${{ env.NAMESPACE }} <{run_url}|{status_message}> at <{commit_url}|{commit_sha}>'
          mention_users: '${{ env.SLACK_MENTION_USERS }}'
          mention_users_when: 'failure,warnings'
          footer: '<{repo_url}/tree/${{ steps.extract_branch.outputs.branch }}|{repo}@${{ steps.extract_branch.outputs.branch }}>'
        env:
          SLACK_WEBHOOK_URL: '${{ env.SLACK_WEBHOOK }}'
